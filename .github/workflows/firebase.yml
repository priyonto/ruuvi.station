name: Upload to Firebase

on:
  push:
    branches: [ github-actions-v1 ]

jobs:
  build:

    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        submodules: 'recursive'

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: 2.6

    - name: Install dependencies
      run: |
        gem install bundler
        bundle install --jobs 4 --retry 3

    - name: Remove existing localisation directory
      run: rm -rf ${{ github.workspace }}/station.localization

    - name: Clone localisation submodule
      run: git clone -b dev https://github.com/ruuvi/station.localization.git ${{ github.workspace }}/station.localization

    - name: Fastlane
      run: bundle exec fastlane --verbose upload_to_firebase build_number:407 scheme:station_dev
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        FASTLANE_PASSWORD: ${{ secrets.FASTLANE_PASSWORD }}
        FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD: ${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}
        LC_ALL: en_US.UTF-8
        LANG: en_US.UTF-8